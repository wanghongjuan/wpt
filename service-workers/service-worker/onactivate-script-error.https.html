<!DOCTYPE html>
<script src="/resources/testharness.js"></script>
<script src="resources/testharness-helpers.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script src="resources/test-helpers.sub.js"></script>
<script>
function wait_for_install(worker) {
  return new Promise(function(resolve, reject) {
    worker.addEventListener('statechange', function(event) {
      if (worker.state == 'installed')
        resolve();
      else if (worker.state == 'redundant')
        reject();
      });
  });
}

function wait_for_activate(worker) {
  return new Promise(function(resolve, reject) {
    worker.addEventListener('statechange', function(event) {
      if (worker.state == 'activated')
        resolve();
      else if (worker.state == 'redundant')
        reject();
    });
  });
}

function make_test(name, SCRIPT) {
  promise_test(async t => {
    const SCOPE = SCRIPT;
    const registration =
        await service_worker_unregister_and_register(t, SCRIPT, SCOPE);
    await wait_for_install(registration.installing);
    await wait_for_activate(registration.waiting);

    t.add_cleanup(async() => {
      if (registration)
        await registration.unregister();
    });

  }, name);
}

[
  {
    name: 'activate handler throws an error',
    script: 'resources/onactivate-throw-error-worker.js',
  },
  {
    name: 'activate handler throws an error, error handler does not cancel',
    script: 'resources/onactivate-throw-error-with-empty-onerror-worker.js',
  },
  {
    name: 'activate handler dispatches an event that throws an error',
    script: 'resources/onactivate-throw-error-from-nested-event-worker.js',
  },
  {
    name: 'activate handler throws an error that is cancelled',
    script: 'resources/onactivate-throw-error-then-cancel-worker.js',
  },
  {
    name: 'activate handler throws an error and prevents default',
    script: 'resources/onactivate-throw-error-then-prevent-default-worker.js',
  }
].forEach(function(test_case) {
    make_test(test_case.name, test_case.script);
  });
</script>
